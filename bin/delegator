#!/usr/bin/env php
<?php

declare(strict_types=1);

namespace SmartAssert\RunnerDelegator\Bin;

const VERSION = 'dev-master';

use Monolog\Formatter\JsonFormatter;
use Monolog\Handler\StreamHandler;
use Monolog\Logger;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Console\Output\StreamOutput;
use SmartAssert\RunnerDelegator\Command\RunCommand;
use SmartAssert\RunnerDelegator\RunnerClient\ConfigurationFactory;
use SmartAssert\RunnerDelegator\RunnerClient\Factory as RunnerClientFactory;
use SmartAssert\RunnerDelegator\Services\RunnerClientHandlerFactory;
use Symfony\Component\Console\SingleCommandApplication;
use webignition\TcpCliProxyClient\Services\ConnectionStringFactory;
use webignition\YamlDocumentGenerator\YamlGenerator;

require dirname(__DIR__) . '/vendor/autoload.php';

$logger = new Logger('runner-logger');
$logHandler = new StreamHandler(__DIR__ . '/debug.log');
$logHandler->setFormatter(new JsonFormatter());

$output = new StreamOutput(STDOUT);

$runnerClientHandler = (new RunnerClientHandlerFactory())->create($output);
$runnerClientFactory = new RunnerClientFactory(
        new ConfigurationFactory(),
        new ConnectionStringFactory(),
        $runnerClientHandler
);

$logger->pushHandler($logHandler);

$command = new RunCommand(
    $runnerClientFactory->loadFromEnv($_SERVER),
    $logger,
    new YamlGenerator(),
);

$application = new SingleCommandApplication();
$application->setName((string) $command->getName());
$application->setDefinition($command->getDefinition());

$application
    ->setVersion(VERSION)
    ->setCode(function (InputInterface $input, OutputInterface $output) use ($command) {
        return $command->run($input, $output);
    })
;

$exitCode = $application->run(null, $output);

exit($exitCode);
